# Vision DT Development Roadmap

## Overview

This document summarizes the current breakthroughs in the Vision Digital Twin lighting and optics system, and documents features that still need to be developed for complete physical accuracy simulation.

---

## Part 1: Current Breakthroughs (Implemented)

### 1.1 Bootstrap System ‚úÖ

**Status:** Production Ready

Automatic stage configuration system that runs on every stage open:
- Sets millimeter units (metersPerUnit = 0.001)
- Adds Vision DT attributes to all lights
- Starts real-time watchers for parameter sync
- Modular capability architecture (add new features as numbered .py files)

**Key Files:**
- `bootstrap/loader.py` ‚Äî Core orchestration
- `bootstrap/capabilities/` ‚Äî Modular capability scripts

---

### 1.2 Spectral Power Distribution (SPD) System ‚úÖ

**Status:** Production Ready

Three modes for defining light color from spectral data:

| Mode | Description | Use Case |
|------|-------------|----------|
| `gaussian` | Peak wavelength + FWHM bandwidth | Quick LED simulation |
| `csv` | Load SPD from CSV file | Real datasheet curves |
| `manual` | Direct wavelength/intensity arrays | Custom profiles |

**Technical Implementation:**
- Full CIE 1931 2¬∞ Standard Observer color matching (380-780nm, 5nm steps)
- XYZ to linear sRGB conversion matrix
- Gaussian SPD approximation from peak Œª + FWHM
- `whiteMix` parameter for realistic white LED simulation

**Key Files:**
- `bootstrap/utils/spectral.py` ‚Äî CIE integration, SpectralCurve class
- `bootstrap/lighting-profiles/spd/` ‚Äî CSV library (D65, warm/cool white, incandescent)

**Attributes:**
```
visiondt:led:enabled           ‚Üí Enable LED color mode
visiondt:led:spdMode           ‚Üí "gaussian", "csv", or "manual"
visiondt:led:peakWavelength    ‚Üí Peak Œª (nm)
visiondt:led:spectralBandwidth ‚Üí FWHM (nm)
visiondt:led:whiteMix          ‚Üí Blend with white (0-1)
visiondt:led:spdCsvPath        ‚Üí Path to CSV file
visiondt:led:computedColor     ‚Üí Read-only calculated RGB
```

---

### 1.3 Photometric Luminosity System ‚úÖ

**Status:** Production Ready

Converts real LED datasheet brightness (mcd, mlm) to Omniverse intensity:

**Conversion Pipeline:**
```
mcd (millicandela) ‚Üí nits (cd/m¬≤) ‚Üí Omniverse intensity + exposure
```

**Key Formulas:**
- `nits = mcd / (emitter_area_mm¬≤ √ó 1e-6)`
- `intensity = clamp(nits, 0.01, 100)`
- `exposure = log2(nits / intensity)`

**Key Files:**
- `bootstrap/utils/luminous.py` ‚Äî Photometric conversions

**Attributes:**
```
visiondt:led:useLuminousIntensity ‚Üí Enable datasheet brightness
visiondt:led:luminousIntensity    ‚Üí Value in mcd
visiondt:led:luminousFlux         ‚Üí Value in mlm
visiondt:led:emitterWidthMm       ‚Üí Die width (mm)
visiondt:led:emitterHeightMm      ‚Üí Die height (mm)
visiondt:led:currentRatio         ‚Üí Dimming factor (0-1)
visiondt:led:computedNits         ‚Üí Read-only calculated luminance
visiondt:led:computedIntensity    ‚Üí Read-only Omniverse intensity
visiondt:led:computedExposure     ‚Üí Read-only Omniverse exposure
```

---

### 1.4 Multi-Spectrum Kelvin System ‚úÖ

**Status:** Production Ready

Per-channel color temperature control using Kelvin values:

**Attributes:**
```
visiondt:overallTemperature ‚Üí Master temperature (K)
visiondt:redTemperature     ‚Üí Red channel (K)
visiondt:greenTemperature   ‚Üí Green channel (K)
visiondt:blueTemperature    ‚Üí Blue channel (K)
```

**Algorithm:** Tanner Helland Kelvin-to-RGB with per-channel multiplication

---

### 1.5 Real-Time Synchronization ‚úÖ

**Status:** Production Ready

Three watcher modules for live parameter updates:

| Watcher | Purpose |
|---------|---------|
| `LightWatcher` | Auto-add Vision DT attributes to newly created lights |
| `ColorSync` | Sync Kelvin temperature changes to `inputs:color` |
| `LEDColorSync` | Sync SPD/luminosity changes to Omniverse light properties |

**Key Feature:** Vision DT settings **always override** Omniverse defaults when enabled

---

### 1.6 LED Presets Library ‚úÖ

**Status:** Production Ready

Built-in LED presets for common wavelengths:

| Preset | Wavelength | Description |
|--------|------------|-------------|
| `uv_365` | 365nm | UV-A LED |
| `uv_385` | 385nm | Near-UV LED |
| `blue_450` | 450nm | Blue LED |
| `cyan_505` | 505nm | Cyan LED |
| `green_520` | 520nm | Green LED |
| `green_530` | 530nm | True Green (OSRAM LT QH9G) |
| `lime_555` | 555nm | Lime LED |
| `amber_590` | 590nm | Amber LED |
| `red_625` | 625nm | Red LED |
| `red_660` | 660nm | Deep Red LED |
| `ir_850` | 850nm | Near-IR LED |
| `ir_940` | 940nm | IR LED |

**OSRAM LT QH9G Brightness Groups:**
- `osram_lt_qh9g` (Q2): 90 mcd
- `osram_lt_qh9g_r1`: 126 mcd
- `osram_lt_qh9g_s1`: 200 mcd
- `osram_lt_qh9g_t2`: 400 mcd

---

### 1.7 SPD File Library ‚úÖ

**Status:** Production Ready

Standard spectral profiles in `_build/bootstrap/lighting-profiles/spd/`:

| File | Description |
|------|-------------|
| `D65_daylight_6500K.csv` | CIE D65 standard daylight |
| `white_LED_cool_5000K.csv` | Phosphor white LED (cool) |
| `white_LED_warm_3000K.csv` | Phosphor white LED (warm) |
| `flat_equal_energy_white.csv` | Equal power reference |
| `incandescent_2700K.csv` | Black-body radiator |

---

## Part 2: Features To Be Developed

### 2.0 Zemax Lens Integration üî¥ IN PROGRESS

**Priority:** Critical ‚Äî Foundation for all lens/camera parameters

**What It Is:**
Import Zemax lens files (`.ZMX`, `.ZAR`) to create a lens library. All lens optical parameters come from Zemax ‚Äî this is the **single source of truth** for lens data.

**Data Flow:**
```
Zemax File (.zmx) ‚Üí Parser ‚Üí lens_data.json ‚Üí Lens Library ‚Üí Camera Attributes
```

**What Zemax Provides:**
- Focal length, F-number, working distance
- Distortion coefficients (radial, tangential)
- MTF curves (sagittal, tangential, field-dependent)
- Chromatic aberration data
- Telecentricity parameters
- PSF data (optional export)

**Implementation Status:**
- üìÑ Research complete: `ZEMAX_LENS_INTEGRATION.md`
- ‚è≥ Parser module: Not started
- ‚è≥ Lens library: Not started
- ‚è≥ Camera UI integration: Not started

**Reference:** `ZEMAX_LENS_INTEGRATION.md` ‚Äî Complete implementation specification

---

### 2.1 MTF (Modulation Transfer Function) üî¥ CRITICAL

**Priority:** üî¥ Critical for Industrial Vision

**Why MTF is Critical:**
Industrial machine vision relies on **edge detection** for:
- Dimensional measurement (edge-to-edge distances)
- Defect detection (scratches, chips, cracks)
- Part presence/absence verification
- Barcode/QR code reading

**Without MTF:** Synthetic images have perfect edges. Real cameras have MTF rolloff. Edge detection algorithms trained on synthetic data will **fail or underperform** on real camera images.

**Data Source:** Zemax MTF analysis (sagittal/tangential curves, field positions)

**Required Implementation:**

1. **MTF Data from Zemax**
   - Extract via ZOSPy or parse from analysis exports
   - Store field-dependent curves (center, mid, edge)
   - Store sagittal and tangential separately

2. **Post-Process MTF Blur**
   - Convert MTF curves to PSF via inverse FFT
   - Apply field-dependent blur kernel
   - GPU acceleration for performance

3. **Attributes (from Zemax):**
   ```
   visiondt:lens:mtfDataPath        ‚Üí Path to MTF JSON/CSV
   visiondt:lens:mtfSpatialFreq     ‚Üí [10, 20, 30, 50, 100] lp/mm
   visiondt:lens:mtfContrastSagittal ‚Üí [0.95, 0.90, 0.85, 0.75, 0.50]
   visiondt:lens:mtfContrastTangential ‚Üí [0.95, 0.90, 0.85, 0.75, 0.48]
   visiondt:lens:mtfFieldPositions  ‚Üí [0.0, 0.5, 1.0]
   visiondt:lens:mtfAt50lpmm        ‚Üí 0.75 (quick reference)
   visiondt:lens:mtfAt100lpmm       ‚Üí 0.50 (quick reference)
   visiondt:lens:mtfBlurEnabled     ‚Üí true
   ```

**Reference:** `ZEMAX_LENS_INTEGRATION.md` Section 11 (Implementation Tiers)

---

### 2.2 Light Profiles as Saved Presets üî¥ NOT IMPLEMENTED

**Priority:** High

**What It Is:**
Save complete light configurations (SPD + luminosity + geometry) as reusable profile files.

**Required Implementation:**

1. **Profile File Format**
   ```json
   {
     "name": "OSRAM_LT_QH9G_Q2",
     "manufacturer": "OSRAM",
     "model": "LT QH9G",
     "spectral": {
       "mode": "gaussian",
       "peakWavelength": 530,
       "bandwidth": 33,
       "whiteMix": 0.0
     },
     "luminosity": {
       "luminousIntensity": 90,
       "emitterWidth": 0.5,
       "emitterHeight": 0.3
     },
     "geometry": {
       "lightType": "RectLight",
       "width": 1.0,
       "height": 0.5
     },
     "electrical": {
       "forwardCurrent": 5.0,
       "forwardVoltage": 2.85
     }
   }
   ```

2. **Attributes:**
   - `visiondt:led:profilePath` (Asset) ‚Äî Path to JSON profile
   - `visiondt:led:profileName` (String) ‚Äî Display name

3. **Functions:**
   - `load_light_profile(prim, profile_path)` ‚Äî Apply profile to light
   - `save_light_profile(prim, profile_path)` ‚Äî Save current settings
   - `list_available_profiles()` ‚Äî Get installed profiles

4. **Directory:**
   - `bootstrap/lighting-profiles/led/` ‚Äî JSON profile library

---

### 2.3 Camera Intrinsic Parameters üî¥ NOT IMPLEMENTED

**Priority:** Critical

**What It Is:**
Camera matrix defining focal length, principal point, and skew ‚Äî core of geometric projection.

**Data Source:** Combination of:
- **Lens data from Zemax** (focal length, FOV)
- **Sensor data from camera datasheet** (pixel pitch, sensor size)

**Required Implementation:**

```
# From Zemax lens data:
visiondt:camera:focalLengthMm     ‚Üí Focal length (mm) ‚Äî from Zemax EFL

# From camera sensor datasheet:
visiondt:camera:sensorWidthMm     ‚Üí Sensor physical width
visiondt:camera:sensorHeightMm    ‚Üí Sensor physical height
visiondt:camera:pixelPitchUm      ‚Üí Pixel pitch (¬µm)
visiondt:camera:principalPointX   ‚Üí Principal point X (pixels)
visiondt:camera:principalPointY   ‚Üí Principal point Y (pixels)
visiondt:camera:skew              ‚Üí Skew coefficient (usually 0)
```

---

### 2.4 Lens Distortion üî¥ IN PROGRESS (via Zemax)

**Priority:** Critical

**What It Is:**
Radial and tangential distortion coefficients for accurate geometric simulation.

**Data Source:** Zemax distortion analysis

**Required Implementation:**

```
# From Zemax (extracted by parser):
visiondt:lens:k1, k2, k3         ‚Üí Radial distortion coefficients
visiondt:lens:p1, p2             ‚Üí Tangential distortion coefficients
visiondt:lens:distortionModel    ‚Üí "brown-conrady" or "fisheye"
```

**Implementation Tiers:**
- **Tier 1 (Render-time):** Apply via `OmniLensDistortionOpenCvPinholeAPI` for k1-k3, p1-p2
- **Tier 2 (Post-process):** Higher-order polynomial (k4+) via image remapping

**Reference:** `ZEMAX_LENS_INTEGRATION.md` Section 12.5

---

### 2.5 Sensor Noise Simulation üî¥ NOT IMPLEMENTED

**Priority:** High

**What It Is:**
Read noise, shot noise, and fixed-pattern noise for realistic sensor simulation.

**Required Implementation:**

```
visiondt:camera:readNoiseE       ‚Üí Read noise (e‚Åª rms)
visiondt:camera:darkCurrentE     ‚Üí Dark current (e‚Åª/pixel/sec)
visiondt:camera:gainE2DN         ‚Üí Conversion gain (e‚Åª per DN)
visiondt:camera:bitDepth         ‚Üí Output bit depth (8, 10, 12, 16)
visiondt:camera:noiseEnabled     ‚Üí Enable noise simulation
```

**Implementation:** Post-process noise injection based on exposure time and gain

---

### 2.6 Thermal Derating üü° FUTURE

**Priority:** Medium

**What It Is:**
LED wavelength and flux shift with junction temperature.

**Typical Effects:**
- Wavelength shift: ~0.1 nm/¬∞C for InGaN LEDs
- Flux reduction: ~0.5%/¬∞C

**Required Implementation:**

```
visiondt:led:junctionTempC       ‚Üí Operating temperature (¬∞C)
visiondt:led:tempCoeffWavelength ‚Üí nm/¬∞C coefficient
visiondt:led:tempCoeffFlux       ‚Üí %/¬∞C coefficient
```

---

### 2.7 Multi-Peak SPD (Phosphor LEDs) üü° FUTURE

**Priority:** Medium

**What It Is:**
White LEDs use blue pump + phosphor, creating multi-peak SPD.

**Required Implementation:**
- Support multiple peaks in SpectralCurve class
- Preset for typical phosphor LED shapes
- CCT (Correlated Color Temperature) calculation

---

### 2.8 IES Profile Integration üü° PARTIAL

**Priority:** High

**Current State:**
- `visiondt:iesProfile` attribute exists
- Not actively synced to Omniverse Shaping API

**Required Implementation:**
- Sync IES path to `inputs:shaping:ies:file`
- Support asymmetric viewing angles (e.g., 170¬∞ √ó 115¬∞)
- Fallback cone angle approximation when no IES

---

### 2.9 Spatial Uniformity üî¥ NOT IMPLEMENTED

**Priority:** Medium

**What It Is:**
Non-uniform illumination across the light's output (center vs. edge brightness).

**Required Implementation:**

```
visiondt:led:uniformityProfile   ‚Üí Asset path to uniformity map
visiondt:led:uniformityCenter    ‚Üí Center brightness (0-1)
visiondt:led:uniformityEdge      ‚Üí Edge brightness (0-1)
```

---

### 2.10 Custom UI Panel üî¥ NOT IMPLEMENTED

**Priority:** Low (usability improvement)

**What It Is:**
Dedicated UI window for Vision DT light control with sliders, presets, and visual feedback.

**Note:** Research completed, code templates exist in changes.log but feature was never implemented. Current workflow uses Raw USD Properties panel.

---

## Part 3: Implementation Priority Matrix

| Feature | Priority | Source | Complexity | Impact |
|---------|----------|--------|------------|--------|
| **Zemax Lens Integration** | üî¥ Critical | Zemax files | High | Foundation for all lens params |
| **MTF Post-Process** | üî¥ Critical | Zemax MTF | High | Essential for edge detection |
| Lens Distortion | üî¥ Critical | Zemax distortion | Medium | Measurement accuracy |
| Camera Intrinsics | üî¥ Critical | Zemax + sensor spec | Medium | Core geometric accuracy |
| Light Profiles (JSON) | üü° High | LED datasheets | Medium | Reusable configurations |
| Sensor Noise | üü° High | Camera datasheet | Medium | Training data realism |
| IES Integration | üü° High | IES files | Low | Already partially done |
| Chromatic Aberration | üü° Medium | Zemax CA | Medium | Color fringing accuracy |
| Thermal Derating | üü° Medium | LED datasheet | Low | Environmental accuracy |
| Multi-Peak SPD | üü° Medium | LED datasheet | Medium | White LED accuracy |
| Spatial Uniformity | üü° Medium | Measurements | Medium | Illumination accuracy |
| Custom UI | ‚ö™ Low | N/A | High | Usability only |

---

## Part 4: Suggested Development Order

### Phase 1: Complete Lighting System ‚úÖ
1. ‚úÖ SPD System (DONE)
2. ‚úÖ Luminosity System (DONE)
3. ‚è≥ Light Profiles as JSON files
4. ‚è≥ IES Profile full integration

### Phase 2: Zemax Lens Integration üî¥ CURRENT PRIORITY
**All lens/camera optical data comes from Zemax files**

1. ‚è≥ Zemax file parser module (`bootstrap/utils/zemax_parser.py`)
2. ‚è≥ Lens library structure (`assets/Lenses/Library/`)
3. ‚è≥ Lens profile capability (`25_apply_lens_profile.py`)
4. ‚è≥ Camera UI lens selector

### Phase 3: MTF System üî¥ CRITICAL FOR INDUSTRIAL VISION
**Required for accurate edge-based inspection simulation**

1. ‚è≥ MTF data extraction from Zemax
2. ‚è≥ MTF ‚Üí PSF conversion (inverse FFT)
3. ‚è≥ Field-dependent blur kernel
4. ‚è≥ GPU-accelerated post-process

### Phase 4: Camera/Lens Refinement
1. ‚è≥ Higher-order distortion (k4+)
2. ‚è≥ Telecentric projection override
3. ‚è≥ Chromatic aberration post-process
4. ‚è≥ Camera intrinsic parameters (sensor specs)

### Phase 5: Sensor Simulation
1. ‚è≥ Read noise and shot noise
2. ‚è≥ Bit depth and quantization
3. ‚è≥ Dark current

### Phase 6: Advanced Features
1. ‚è≥ Thermal derating
2. ‚è≥ Multi-peak phosphor SPD
3. ‚è≥ Spatial uniformity maps
4. ‚è≥ PSF convolution (Zemax PSF import)

---

## Part 5: Data Source Summary

| Data Type | Primary Source | Secondary Source |
|-----------|---------------|------------------|
| Lens optical params | **Zemax files (.zmx, .zar)** | ‚Äî |
| Distortion coefficients | **Zemax distortion analysis** | ‚Äî |
| MTF curves | **Zemax MTF analysis** | ‚Äî |
| Chromatic aberration | **Zemax CA analysis** | ‚Äî |
| PSF data | **Zemax Huygens PSF export** | ‚Äî |
| Sensor specs | Camera datasheet | Calibration measurements |
| LED spectral | SPD CSV files | LED datasheet |
| LED luminosity | LED datasheet (mcd, mlm) | Measurements |
| IES profiles | IES files from manufacturer | ‚Äî |

**Key Principle:** Zemax is the **single source of truth** for all lens optical data. New lenses are added by importing Zemax files, not by manually entering parameters.

---

## References

- `ZEMAX_LENS_INTEGRATION.md` ‚Äî **Primary reference for lens system implementation**
- `LIGHTING_AND_OPTICS.md` ‚Äî Current lighting system documentation
- `HARDWARE_SPECS.md` ‚Äî Required hardware parameters
- `DEVELOPMENT_GUIDE.md` ‚Äî Implementation patterns and pitfalls
- `logs/changes.log` ‚Äî Detailed implementation history

---

*Document Version: 1.1*
*Last Updated: December 2025*
*Change: Added Zemax as canonical source for lens data; MTF elevated to Critical priority for industrial vision*

